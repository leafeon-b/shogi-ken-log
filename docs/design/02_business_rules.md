# 業務ルール定義

## 本ドキュメントの目的

本ドキュメントは、本システムにおける
**業務上の制約・前提・例外・権限ルール**を定義する。

ユースケース定義（`01_usecases.md`）で定義された
「何ができるか」に対し、
本ドキュメントでは「**どのような条件・制約のもとで行われるか**」を明確にする。

## 公開範囲・アクセス制御

- 本システムは登録済みユーザーのみが利用できる
- 未登録者は研究会・開催回・対局結果を閲覧・操作できない
- 研究会およびその配下リソースは、以下のユーザーのみが閲覧可能

  - 研究会参加者
  - または、当該開催回の参加者（研究会参加者でないユーザーを含む）

- 配下リソースには以下を含む

  - 開催回
  - 対局結果
  - 対局結果の編集履歴

- 上記条件を満たさないユーザーは、URL 等による直接アクセスであっても閲覧・操作できない

## 研究会に関する業務ルール

- 研究会は、継続的に開催される将棋の集まりを表す
- 研究会には複数の開催回が属する
- 研究会には 1 人以上の参加者が存在する
- 研究会の参加者にはロールが付与される

  - 管理者
  - メンバー

### 研究会削除（高リスク操作）

- 研究会を削除した場合、研究会配下のデータは削除される
- 削除対象には以下を含む

  - 開催回
  - 対局結果
  - 対局結果の編集履歴

## ロール・権限に関する業務ルール

### ロールの性質

- 管理者ロールとメンバーロールは独立した概念である
- 1 人の参加者が、管理者・メンバーの両方のロールを同時に持つことができる

### 管理者に関する制約

- 管理者は常に 1 人以上存在しなければならない
- 管理者ロールは、他の参加者に移譲できる
- 管理者ロールを移譲した後、研究会から退会することができる
- 管理者が 1 人のみの場合、その管理者を削除することはできない

## 開催回に関する業務ルール

- 開催回は必ず 1 つの研究会に属する
- 開催回は、研究会における 1 回分の開催を表す
- 開催回には開始日時・終了日時が存在する

  - 通常は同日中に終了する
  - 例外として、複数日にわたる開催も許容する

- 開催回には必ず 1 人以上の参加者が存在する
- 開催回に参加できるのはユーザーのみである
- 研究会の参加者でないユーザーも、開催回に参加できる

### 開催回の権限

- 開催回の作成・編集・削除は管理者のみが行える
- 開催回の閲覧は、研究会の参加者（管理者・メンバー）および開催回参加者が可能である

### 開催回参加者

- 開催回参加者は、その開催回に実際に参加する人を指す
- 開催回参加者は、研究会参加者である必要はない

  - ゲスト参加などの例外ケースを許容する

### 開催回参加者の参加取消（案 A）

- 開催回参加者の参加取消（除外）は許容する
- ただし、以下の場合は参加取消できない

  - 当該ユーザーが、当該開催回に属する対局結果の対局者として 1 件以上記録されている場合（論理削除を含む）

- 参加取消の結果として、開催回参加者が 0 人になることは許容しない

## 対局結果に関する業務ルール

- 対局結果は開催回に属する
- 対局は、開催回の参加者同士で行われる
- 対局結果は、以下のユーザーが記録・修正・削除できる

  - 研究会の参加者（管理者・メンバー）
  - または、開催回参加者（研究会参加者でないユーザーを含む）

### 対局結果の順序

- 対局結果には、開催回内の順序が存在する
- 順序は開催回ごとに一意であり、同一開催回内で重複してはならない

### 対局結果の削除

- 対局結果の削除は論理削除として扱い、編集履歴を含む記録は残る
- 対局結果を論理削除しても、開催回内の順序は再利用しないため欠番が発生し得る

## 対局結果の編集履歴

- 対局結果の作成・修正・削除時には、編集履歴を自動的に保存する
- 編集履歴はシステムが自動的に記録するものであり、ユーザーが直接操作することはできない
- ユーザーは編集履歴を閲覧することのみができる
- 編集履歴には以下の情報を含める

  - 編集者
  - 編集日時
  - 編集時点の対局結果内容

## スコープ外・前提事項

以下の事項は、本システムのスコープ外とする。

- 棋譜の保存
- 手合割・持ち時間の管理
- レーティング計算
- 勝敗集計のリアルタイム更新
- 研究会の検索
- 招待の承認フロー
